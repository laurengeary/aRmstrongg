---
title: "Module 7 Project"
author: "aRmstrong"
date: "2023-10-30"
output: html_document
bibliogrphy: "BIOL3140.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(MuMIn)
```


## Introduction
Guiding questions: 
Can angle-force measurements predict force-length (FL) relationships in the flexors of the human upper arm?
Does eccentric fatigue shift the FL relationship of human forearm flexors?
Do class-wide force-angle data for isometric MVC accord to a typical FL relationship both under control and fatigued conditions?
Is there a significant shift between θmax between the control and fatigue FL relationships?

## Methods
  The group began by constructing a low-cost load-cell force DAQ system. With this we measured the force of isometric MVCs for ~15 seconds at 12 different angles that were determined using a handmade ganiometer. Then we eccentrically fatigue biceps by repeatedly performing iso-kinetic controlled drops with a heavy book bag for 3 minutes. After resting for 2 minutes we remeasured the force of isometric MVCs at the same 12 angles using the same procedure. We performed this on each of the three group members. 
  After inserting our data from our Arduino sketch into a class directory, we read in the class data and calculated normalized values. We fit different polynomial models to our normalized data and then used AICs to find the best fitting model. Using the model we were able to find the Fmax and θmax. By comparing the two θmax between our two data sets, we were able to determine if there was a significant shift between θ max between the control and fatigue FL relationships.

## Results

```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}

#Loading in all the data 
new_data_files <- list.files("new_data", pattern = ".csv", full.names=TRUE)

empty_list <- list()


for (file in new_data_files) {
  data <- read_csv(file)
  data_columns <- str_split(str_remove(file, "\\.csv"), "_")[[1]]
  data <- data %>%
    mutate(
      team = data_columns[2],
      subject = data_columns[3],
      condition = data_columns[4],
      angle = as.numeric(data_columns[5])
    )
  
  empty_list[[file]] <- data
}

all_data <- bind_rows(empty_list)


#Modifying table so that absolute values are listed. Filtering data that was identified as an issue later in experiment. When creating models, received Error that the degree must be less than number of unique points.Found that "letacianna" and "leticianna" had less unique points than the degree being used for the polynomial

all_data <- all_data %>% 
  mutate(force = abs(all_data$force)) %>% 
  filter(subject != "letacianna") %>% 
  filter(subject != "leticianna") %>% 
  filter(subject != "letiacianna")
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
#Find maximum force for each recording
max_force_each_recording <- all_data %>%
  group_by(team, subject, condition, angle) %>%
  summarize(max_force = max(force, na.rm = TRUE))

#Find maximum force (Fmax) across all angles for each experiment (control or fatigued) for each individual
max_force_each_experiment <- max_force_each_recording %>%
  group_by(team, subject, condition) %>%
  summarize(max_force_all = max(max_force, na.rm = TRUE))

# Norm Force = maximum force for each recording/maximum force (Fmax) across all angles for each experiment
Final_data_table <- max_force_each_recording %>%
  left_join(max_force_each_experiment, by = c("team", "subject", "condition")) %>%
  mutate(max_force_norm = max_force / max_force_all)
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
AICs <- Final_data_table%>%
  group_by(subject,condition)%>%
  summarize(
    m2=AICc(lm(max_force_norm~poly(angle,2))), #second order
    m3=AICc(lm(max_force_norm~poly(angle,3))), #third order
    m4=AICc(lm(max_force_norm~poly(angle,4))) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")%>%
  print()

x.pred <- seq(45,157.5,length.out = 1000) #define 1000 angles from our range

fits <- Final_data_table %>%
  group_by(subject, condition) %>%
  summarize(
    m2 = predict(lm(max_force_norm ~ poly(angle, 2)), newdata = data.frame(angle = x.pred)),
    m3 = predict(lm(max_force_norm ~ poly(angle, 3)), newdata = data.frame(angle = x.pred)),
    m4 = predict(lm(max_force_norm ~ poly(angle, 4)), newdata = data.frame(angle = x.pred))
  ) %>%
  pivot_longer(cols = c(m2, m3, m4), names_to = "model") %>%
  group_by(subject, condition, model) %>%
  summarize(theta_max = x.pred[which.max(value)]) %>%
  print()

#Joining AICs and Fits
best.models <- fits%>%
  left_join(AICs)%>%
  group_by(subject,condition)%>%
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()
```


```{r, Final Analysis}
#Determining whether a shift if θ max is different between the control and fatigue experiments
anova(lm(theta_max~condition,best.models))

#Calculate the mean shift with SEM. 
best.models%>%
  na.omit() %>% 
  pivot_wider(id_cols=subject,names_from = condition,values_from=theta_max)%>%
  mutate(shift=fatigue-control)%>%
  ungroup()%>%
  summarise(mean.shift=mean(shift),se.shift=sd(shift)/sqrt(length(shift)))
```


## Discussion

The P value of the anova test is 0.006778 which is < 0.05. This suggests that there is a statistically significant difference in the theta_max value between the control and fatigue conditions. Using the best models, the mean.shift and se.shift was calculated. The mean.shift calculated was 20.20721 and the standard error was 6.844911. This indicates that the theta_max is shifted 20.20721 units greater in the fatigue condition than in the control condition. 

## Author Contributions
After Lauren obtained the necessary hardware, the team met up outside of class to construct the DAQ system and perform the experiment trials. 
Elisabeth: Contructed the ganiometer, inserted the necessary code chunks, wrote up the methods and author contributions
Phillip constructed the DAQ system, wrote the code. 
Lauren crafted the introduction, 

## References
