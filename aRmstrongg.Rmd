---
title: "Module 7 Project"
author: "aRmstrong"
date: "2023-10-30"
output: html_document
bibliogrphy: "BIOL3140.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(MuMIn)
```


## Introduction
Guiding questions: 
Can angle-force measurements predict force-length (FL) relationships in the flexors of the human upper arm?
Does eccentric fatigue shift the FL relationship of human forearm flexors?
Do class-wide force-angle data for isometric MVC accord to a typical FL relationship both under control and fatigued conditions?
Is there a significant shift between θmax between the control and fatigue FL relationships?

## Methods
  The group began by constructing a low-cost load-cell force DAQ system. With this we measured the force of isometric MVCs for 30 seconds at 12 different angles that were determined using a handmade ganiometer. Then we eccentrically fatigue biceps by repeatedly performing iso-kinetic controlled drops with a heavy book bag for 3 minutes. After resting for 2 minutes we remeasured the force of isometric MVCs at the same 12 angles using the same procedure. We performed this on each of the three group members. 
  After inserting our data from our Arduino sketch into a class directory, we read in the class data and calculated normalized values. We fit different polynomial models to our normalized data and then used AIC to find the best fitting model. Using the model we were able to find the Fmax and θmax. By comparing the two θmax between our two data sets, we were able to determine if there was a significant shift between θmax between the control and fatigue FL relationships.

## Results

```{r}
new_data_files <- list.files("new_data", pattern = ".csv", full.names=TRUE)

empty_list <- list()


for (file in new_data_files) {
  data <- read_csv(file)
  data_columns <- str_split(str_remove(file, "\\.csv"), "_")[[1]]
  data <- data %>%
    mutate(
      team = data_columns[2],
      subject = data_columns[3],
      condition = data_columns[4],
      angle = as.numeric(data_columns[5])
    )
  
  empty_list[[file]] <- data
}

all_data <- bind_rows(empty_list)
```

```{r}



ang <- seq(45,168.75,length.out = 12) #elbow angle

normF <- c(0.71, 0.77, 0.83, 0.91, 0.97, 1.00, 0.96, 0.94, 0.89, 0.84, 0.77, 0.74) #you'll get this by reading in data and calculating normalized values

qplot(ang,normF)+
  geom_point(aes(x=ang[which.max(normF)],
                 y=normF[which.max(normF)]),
             col="red",size=4)

#finding the peak, not visually though. we are obtaining 20 angles

ang[which.max(normF)] #Find angle for Fmax, theta_max


# fit a polynomial curve to the graph

poly.m2 <- lm(normF~poly(ang,2)) #second order polynomia
poly.m3 <- lm(normF~poly(ang,3)) #third order
poly.m4 <- lm(normF~poly(ang,4)) #fourth order

#to find the best model , choose lowest AIC score

AICc(poly.m2,poly.m3,poly.m4) #the second order model fits best

x.pred <- seq(45,157.5,length.out = 1000) #define 1000 angles from our range

normF.pred <- predict(poly.m4,newdata = data.frame(ang=x.pred)) #predict the force using 1000 angles

qplot(ang,normF)+
  geom_point(aes(x=x.pred,y=normF.pred),col="red")+
  geom_point(aes(x=x.pred[which.max(normF.pred)],
                 y=normF.pred[which.max(normF.pred)]),
             size=5,col="blue")

x.pred[which.max(normF.pred)] #theta_max


#detect shifts in Fmax with respect to angle. If we had two data sets, one control and one produced after fatigue, we merely need to compare the two θmax.
#the shift in angle for Fmax predicted by two polynomial models.

normF.fat <- c(0.65, 0.71, 0.81, 0.89,0.92, 0.96, 0.99, 1, 0.96, 0.92, 0.84, 0.77) #fatigue data, you'll get this by reading in data and calculating normalized values


qplot(ang,normF.fat)+
  geom_point(aes(x=ang[which.max(normF.fat)],
                 y=normF.fat[which.max(normF.fat)]),
             col="red",size=4)

ang[which.max(normF.fat)] #Find angle for Fmax for fatigue data

poly.m2.fat <- lm(normF.fat~poly(ang,2)) #second order
poly.m3.fat <- lm(normF.fat~poly(ang,3)) #third order
poly.m4.fat <- lm(normF.fat~poly(ang,4)) #fourth order

AICc(poly.m2.fat,poly.m3.fat,poly.m4.fat) #the second order model fits best

normF.pred.fat <- predict(poly.m2.fat,newdata = data.frame(ang=x.pred)) #predict the force using 1000 angles

qplot(ang,normF)+geom_point(aes(x=x.pred,y=normF.pred.fat),col="red")+geom_point(aes(x=x.pred[which.max(normF.pred.fat)],y=normF.pred.fat[which.max(normF.pred.fat)]),size=5,col="blue")

x.pred[which.max(normF.pred.fat)]-x.pred[which.max(normF.pred)] #shift in angle for Fmax, theta_max


set.seed(1234) #to keep random noise the same

sub <- 1:10 #ten subjects
dat.l <- list() #empty list

#loop to run through subjects and simulate data based on noise added to data above
for(i in sub){
  noise <- rnorm(length(ang),mean = 0.02,sd = 0.01)
  noise2 <- rnorm(length(ang),mean = 0.02,sd = 0.01)
  dat.l[[i]] <- tibble(
    rbind(
      data.frame(ang,force=normF+noise,subject=i,exp="control"),
      data.frame(ang,force=normF.fat+noise2,subject=i,exp="fatigue")
    )  
  )%>%
    group_by(subject,exp)%>%
    mutate(force=force/max(force))
  
}

dat <- do.call(rbind,dat.l) #get data into one tibble

dat%>%
  ggplot(aes(ang,force,col=exp))+geom_point()


AICs <- dat%>%
  group_by(subject,exp)%>%
  summarize(
    m2=AICc(lm(force~poly(ang,2))), #second order
    m3=AICc(lm(force~poly(ang,3))), #third order
    m4=AICc(lm(force~poly(ang,4))) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")%>%
  print()

fits <- dat%>%
  group_by(subject,exp)%>%
  summarize(
    m2=predict(lm(force~poly(ang,2)),newdata=data.frame(ang=x.pred)), #second order
    m3=predict(lm(force~poly(ang,3)),newdata=data.frame(ang=x.pred)), #third order
    m4=predict(lm(force~poly(ang,4)),newdata=data.frame(ang=x.pred)) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(subject,exp,model)%>%
  summarize(theta_max=x.pred[which.max(value)])%>%
  print()


best.models <- fits%>%
  left_join(AICs)%>%
  group_by(subject,exp)%>%
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()

anova(lm(theta_max~exp,best.models))


best.models%>%
  pivot_wider(id_cols=subject,names_from = exp,values_from=theta_max)%>%
  mutate(shift=fatigue-control)%>%
  ungroup()%>%
  summarise(mean.shift=mean(shift),se.shift=sd(shift)/sqrt(length(shift)))
```

## Discussion






## Author Contributions
After Lauren obtained the necessary hardware, the team met up outside of class to construct the DAQ system and perform the experiment trials. 
Elisabeth: Contructed the ganiometer, inserted the necessary code chunks, wrote up the methods and author contributions
Phillip constructed the DAQ system,
Lauren crafted the introduction, 

## References
